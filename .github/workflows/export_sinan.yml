name: SINAN - Exportar, Extrair e Converter

# agenda: todo dia às 07:00 UTC (ajuste conforme desejar). Ex.: '0 7 * * *'
on:
  push:
    branches: [ main ]
  workflow_dispatch: {}    # permite rodar manualmente
  schedule:
    - cron: '0 7 * * *'    # ajuste horário UTC (ex.: 07:00 UTC todo dia)

env:
  PYTHONUNBUFFERED: 1
  OUT_FOLDER: downloads
  OUT_CONVERTED: output

jobs:
  sinan_export:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies (pip)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers and OS deps
        run: |
          # instala navegadores + dependências do SO para execução headless
          python -m playwright install --with-deps
        shell: bash

      - name: Show Python and Playwright versions (debug)
        run: |
          python --version
          python -c "import playwright; print('playwright', playwright.__version__)"
          ls -la

      - name: Ensure download and output folders exist
        run: |
          mkdir -p ${{ env.OUT_FOLDER }}
          mkdir -p ${{ env.OUT_CONVERTED }}
          ls -la

      - name: Run SINAN Playwright script (download)
        env:
          SINAN_USER: ${{ secrets.SINAN_USER }}
          SINAN_PASS: ${{ secrets.SINAN_PASS }}
          OUT_FOLDER: ${{ env.OUT_FOLDER }}
        run: |
          # rodar seu script Playwright que baixa o zip para ./downloads
          python sinan_playwright.py
        shell: bash

      - name: List downloaded files (debug)
        run: |
          echo "Conteúdo de downloads/"
          ls -la ./downloads || true

      - name: Extract / Convert DBF -> Excel
        env:
          OUT_FOLDER: ${{ env.OUT_FOLDER }}
          OUT_CONVERTED: ${{ env.OUT_CONVERTED }}
        run: |
          python extract_and_convert.py

      - name: List output files
        run: |
          echo "Conteúdo de output/"
          ls -la ./output || true

      - name: Upload converted Excel(s) as artifact
        uses: actions/upload-artifact@v4
        with:
          name: sinan-export-excel
          path: output/
